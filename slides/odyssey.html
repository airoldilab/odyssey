<!DOCTYPE html>
<meta charset="utf-8">
<style>

@import url(http://fonts.googleapis.com/css?family=Rambla:400,700,400italic,700italic);
@import url(http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:400,700);
@import url(stack.css);
@import url(style.css);
@import url(highlight.js/styles/monokai.css);

.big {
  font-size: 128px;
}

.caption {
  font-size: 96px;
  text-align: center;
  text-shadow: 0px 2px 6px rgba(0,0,0,.5);
}

</style>
<body class="overview">

<section>
  <h1 class="title">Scientific computing on the<br/>
    Harvard <em class="title">Odyssey</em><br/> cluster</h1>
  <h2 class="author">Gábor Csárdi</h2>
  <h2 class="email">gcsardi@stat.harvard.edu</h2>
</section>

<section>
<h2>Outline</h2>
<ol class="outline">
<li>Organizing your files
<li>The Odyssey cluster
<li>Running the simulations
<li>Profiling and optimizing
<li>Getting help
</ol>
</section>

<!-- --------------------------------------------------- -->

<section>
<h1>I. Organizing your files</h1>
</section>

<section>
<h2>Project: a normal model with missing data</h2>
<p>
\[ 
\renewcommand{\vec}[1]{{\mathbf{#1}}}
\newcommand{\mat}[1]{{\mathbf{#1}}}
\begin{align}
X_{i,j} & = L_{i,l[j]} + R_{i,j} \\
\vec{L}_i & \sim \mathcal{N}_{2}(0,\mat\Psi) \\
R_{i,j} & \sim \mathcal{N}(0,\theta_{j}) \\
p(I_{i,j} = 0 |X_{i,j}=x) & = 
   \frac{1}{1+\exp(-\eta^0_{j}-\eta^1_{j} X_{i,j})}
\end{align}
 \]
</p>
<p>
\[ i=[1,\dots,100], j=[1,\dots,4] \]
\[ l[1]=1, l[2]=1, l[3]=2, l[4]=2 \]
</p>
</section>

<section>
<h2>Directories</h2>
<pre class="code">
stat221             <span class="em"># stat 221 root directory</span>
├─R221              <span class="em"># R package for all code</span>
│ ├─DESCRIPTION
│ ├─NAMESPACE
│ ├─R               <span class="em"># R code files</span>
│ │ ├─util.R        <span class="em"># Common for all projects</span>
│ │ └─nnm.R
│ ├─data            <span class="em"># data files (small)</span>
│ │ └─nnm.rda
│ └─inst
│   └─tests
│     └─test_nnm.R
├─data              <span class="em"># data files (bigger)</span>
└─code              <span class="em"># code for runs, submission files, etc.</span>
  └─insilico
</pre>
</section>

<section>
<h2>The R code</h2>
<pre class="code"><code class="R">nnmFit <- function(data, start, steps=50) {
  ## MCMC
  samples <- vector("list", steps)
  samples[[1]] <- state <- start
  for (i in (1:steps)[-1]) {
    state <- nnmDrawL(state)
    state <- nnmDrawMissing(state)
    state <- nnmDrawNu(state)
    state <- nnmDrawPsi(state)
    state <- nnmDrawTheta(state)
    samples[[i]] <- state
  }
  samples
}
</code></pre>
</section>

<section>
<h2>The R code, #2</h2>
<pre class="code"><code class="R">nnmSim <- function(psi, theta, nu, nGenes=5000) {
  ## Simulate artificial data
  L <- rmvnorm(nGenes, sigma=psi)
  R <- rmvnorm(nGenes, sigma=theta)
  X <- X2 <- L[,c(1,1,2,2)] + R
  for (i in 1:4) {
    cens.prob <- 1/(1+exp(-(nu[i+4] + nu[i] * X2[,i])))
    X2[,i][runif(length(cens.prob)) < cens.prob] <- NA
  }
  list(data=X, cdata=X2, obs=!is.na(X2), L=L, R=R, psi=psi, theta=theta, nu=nu)
}

nnmStart <- function(data) {
  ## Start state for MCMC
  ...
  state
}

nnmDrawL <- function(state) {
  ## Conditional normal draw
  ... update state$L here ...
  state
}

... other conditional draws ...
</code></pre>
</section>

<section>
<h2>Setting up a git repository on <span class="url">
  <a href="http://bitbucket.org">bitbucket.org</a></span></h2>
<ul>
<li>Helps to keep files under control.
<li>Easier to fix bugs.
<li>Simplifies collaboration.
<li>Issue tracker to make a TODO list.
<li>Reproducible research (more later).
</ul>
</section>

<section>
<h2>Creating an R package</h2>
<ul>
<li>Move and install files together. 
<li>Load necessary functions into R with a single command.
<li>May contain code and data (if data is small) or code only.
</ul>
</section>

<section>
<h2>Reproducible research</h2>
<ul>
<li>Essential, but often not taken seriously.
<li>What can we do?
<li>Keep an electronic lab-book.
<li>Software versions (git hash for R package!).
<li><code>sessionInfo()</code> output.
<li>Random seed(s). Initialize based on current microseconds:
<pre class="code"><code class="R">fracSec <- function() {
  as.numeric(format(Sys.time(), "%OS")) * 10^5
}
</code></pre>
</ul>
</section>

<section>
<h2>Testing</h2>
<ul>
<li>Unit testing: not much more effort to make it more formal.
<li><code>testthat</code> package example.
<pre class="code"><code class="R">test_that("nnm start state generator works", {
  library(R221)
  set.seed(42)
  psi <- cbind(c(1,.9), c(.9,1))
  theta <- .1 * diag(4)
  nu <- c(0, 0, 0, 0, -Inf, -Inf, -Inf, -Inf)
  data <- nnmSim(psi, theta, nu)
  start <- nnmStart(data)
  expect_that(sort(names(start)), equals(sort(c("data", "L", "nu",
                                                "obs", "psi", "theta"))))
})
</code></pre>
</ul>
</section>

<!-- --------------------------------------------------- -->

<section>
<h1>II. The Odyssey cluster</h1>
</section>

<section>
<h2>What is <a href="https://rc.fas.harvard.edu/">Odyssey?</a></h2>
<p><ul>
<li>Linux cluster for scientific computing.
<li>Make sure that you read the
  <a href="https://rc.fas.harvard.edu/odyssey-quickstart-guide/">
    quick start guide</a>.
<li><a href="https://account.rc.fas.harvard.edu/request/">
  Requesting</a> an account
<li>Authentication: two-stage OpenAuth.
</section>

<section>
<h2>Accessing Odyssey</h2>
<ul>
<li>From OSX and Linux: via the <code>ssh</code> program.
<li>From Windows: <code>putty</code> (free) or <code>SecureCRT</code>
  (commertial).
<li>Unix basics: see <a href="https://software.rc.fas.harvard.edu/training/intro_unix/latest">tutorial from RC.
</ul>
</section>

<section>
<h2>File systems on Odyssey</h2>
<p>Home directory: 40GB quota, backed up nightly.</p>
<p><code>/n/holyscratch</code>: 273TB storage, no quota. 90 days
  retention policy. Contact rchelp to get space here.</p>
<p><code>/scratch</code>: local storage for each node.</p>
</section>

<section>
<h2>File transfer to/from Odyssey</h2>
<p>From OSX and Linux: <code>scp</code>. E.g. to odyssey:
<pre class="code">
scp R221_0.1.tar.gz odyssey.fas.harvard.edu:
scp mydata.RData \
    odyssey.fas.harvard.edu:/n/holyscratch/myuser/data/
</pre>
<p>
From odyssey:
<pre class="code">
scp odyssey.fas.harvard.edu:results.RData .
</pre>
</p>
</section>

<section>
<h2>Easier login and file transfer</h2>
<p>
On OSX and Linux. Put this into your <code>~/.ssh/config</code> file
on your laptop/desktop (not on odyssey!):
<pre class="code">
Host odyssey.fas.harvard.edu odyssey ody
     Hostname odyssey.fas.harvard.edu
     User csardi
     ControlMaster auto
     ControlPath /tmp/%r@%h:%p
</pre>
</p>
<p>
After this, you only need to authenticate yourself at
your first login. Until you close this first session,
other sessions don't need your password and verification key.
</p>
<p>
Plus, you don't need to type out the full odyssey hostname,
but you can use <code>ody</code> instead!
</p>
</section>

<section>
<h2>Module system</h2>
<p>
<ul>
<li>Support for various software packages is modular on odyssey.
<li>If you want to use a piece of software, you need to load
  its module:
  <pre class="code">
    [csardi@rclogin07 ~]$ module load math/R-3.0.1
    Loading module hpc/intel-mkl-11.0.0.079.
    Loading module hpc/gcc-4.7.2.
    Loading module hpc/java-1.7.0_13.
    Loading module math/R-3.0.1.  </pre>
<li>Dependencies are handled automatically.
<li>Type in <code>module</code> without arguments to list the
available options.
<li>If you always want to load a module automatically, whenever you
log in, put the command into your <code>~/.bashrc</code> file.
</ul>
</p>
</section>

<section>
<h2>Running a quick test simulation</h2>
</section>

<section>
<h2>Debugging an error</h2>
</section>

<!-- --------------------------------------------------- -->

<section>
<h1>III. Running the simulations</h1>
</section>

<section>
<h2>SLURM basics</h2>
</section>

<section>
<h2>Interactive jobs</h2>
<p><code>salloc</code> and <code>srun</code></p>
<p>ssh to <code>slurmint</code></p>
<p><code>srun --pty --x11=first MYPROGRAM</code></p>
<p><code>sattach</code></p>
<p>Exclusive access to a node</p>
</section>

<section>
<h2>Memory requirements</h2>
</section>

<section>
<h2>Non-interactive jobs</h2>
<h2><code>sbatch</code></h2>
</section>

<section>
<h2>Creating a submission file (aka <code>bsub</code> file)</h2>
</section>

<section>
<h2>Job arrays</h2>
</section>

<section>
<h2>Modifying the R code to work better with SLURM</h2>
</section>

<section>
<h2>Submitting the jobs</h2>
</section>

<section>
<h2>SLURM commands</h2>
<p>General notes</p>
<code>sinfo</code><br/>
<code>squeue</code><br/>
<code>sacct</code><br/>
<code>sstat</code><br/>
<code>sreport</code><br/>
<code>scancel</code><br/>
<code>sbcast</code><br/>
<code>strigger</code><br/>
<code>scontrol</code><br/>
</section>

<section>
<h2>Dependencies between jobs</h2>
</section>

<section>
<h2>Matlab jobs</h2>
</section>

<!-- --------------------------------------------------- -->

<section>
<h1>IV. Profiling and Optimizing</h1>
</section>

<section>
<h2>CPU time profiling</h2>
</section>

<section>
<h2>Memory profiling</h2>
</section>

<!-- --------------------------------------------------- -->

<section>
<h1>V. Getting help</h1>
</section>

<section>
<h2>This tutorial @ <span class="url">bitbucket.org</span></h2>
</section>

<section>
<h2>Harvard RC web pages</h2>
</section>

<section>
<h2>SLURM documentation</h2>
</section>

<section>
<h2>rchelp email</h2>
</section>

<script src="http://d3js.org/d3.v2.js?2.7.3"></script>
<script src="stack.v0.js"></script>
<script type="text/javascript"
   src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
MathJax.Hub.Config({
  showProcessingMessages: false,
});
</script>
</script>

<script src="highlight.js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
